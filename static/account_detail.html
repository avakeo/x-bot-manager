<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>投稿管理 - X Manager</title>
    <link rel="stylesheet" href="style.css?v=4">
</head>
<body>
    <div class="container">
        <header>
            <h1 id="account-name">読み込み中...</h1>
            <div style="display:flex; gap:10px; align-items:center;">
                <button id="themeToggle" class="btn-ghost" type="button">🌙 ダーク</button>
                <a href="index.html" class="btn-add" style="background:#666;">ダッシュボードに戻る</a>
            </div>
        </header>

        <div class="container-3col">
            <aside class="column images-col">
                <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
                    <h3 style="margin:0;">画像</h3>
                </div>
                <div style="background:var(--tab-bg); border:1px solid var(--border); border-radius:8px; padding:8px; margin-bottom:10px; font-size:0.85em;">
                    <strong>💡 複数選択:</strong><br>
                    • 単クリック: 1枚だけ選択
                    • <kbd>Ctrl</kbd> + クリック: 追加/解除<br>
                    • <kbd>Shift</kbd> + クリック: 範囲選択<br>
                </div>
                <div id="drop-zone">ドラッグ＆ドロップで追加</div>
                <div id="image-gallery" class="gallery"></div>
            </aside>

            <main class="column form-col">
                <div class="tab-nav">
                    <button class="tab-btn active" data-tab="single" onclick="switchFormTab('single')">通常投稿</button>
                    <button class="tab-btn" data-tab="bulk" onclick="switchFormTab('bulk')">一括予約</button>
                    <button class="tab-btn" data-tab="mega" onclick="switchFormTab('mega')">メガ予約</button>
                </div>

                <div class="form-group">
                    <label>選択画像</label>
                    <div id="selected-image-preview" class="image-preview-multi">
                        <p style="color:#999; margin:0; text-align:center;">画像を選択してください（最大4枚 / メガは150枚）</p>
                    </div>
                    <small style="color:#666; display:block; margin-top:5px;" id="image-count">選択中：0 / 4</small>
                </div>

                <div id="tab-single" class="tab-panel active">
                    <div style="background:var(--tab-bg); border:1px solid var(--border); border-radius:8px; padding:10px; margin-bottom:12px;">
                        <strong>📝 通常投稿について</strong>
                        <p style="margin:6px 0 0 0; font-size:0.9em; line-height:1.5;">1回の予約で最大4枚の画像を投稿できます。指定した日時に1回だけ投稿されます。</p>
                    </div>
                    <form id="tweetForm">
                        <div class="form-group">
                            <label for="content">ツイート内容（オプション）</label>
                            <textarea id="content" placeholder="テキストなし（画像のみ）でも投稿できます。"></textarea>
                            <small id="char-count">0 / 280</small>
                        </div>

                        <div class="card-section">
                            <div class="form-group">
                                <label for="scheduled_at">予約日時</label>
                                <input type="datetime-local" id="scheduled_at" required>
                            </div>
                        </div>

                        <button type="submit" class="btn-save">予約する</button>
                    </form>
                </div>

                <div id="tab-bulk" class="tab-panel" style="display:none;">
                    <div style="background:var(--tab-bg); border:1px solid var(--border); border-radius:8px; padding:10px; margin-bottom:12px;">
                        <strong>📦 一括予約について</strong>
                        <p style="margin:6px 0 0 0; font-size:0.9em; line-height:1.5;">選択した画像を1枚ずつ、指定した間隔で順次投稿します。画像ごとに異なるテキストを設定可能。</p>
                    </div>
                    <form id="bulkTweetForm">
                        <div class="card-section">
                            <div class="form-group">
                                <label for="bulk_start_time">開始日時</label>
                                <input type="datetime-local" id="bulk_start_time" required>
                                <small style="color:#666; display:block; margin-top:5px;">📅 最初の投稿をいつにするか設定してください</small>
                            </div>

                            <div class="form-group">
                                <label for="bulk_interval">間隔</label>
                                <select id="bulk_interval" required>
                                    <option value="">選択してください</option>
                                    <option value="1">1時間ごと</option>
                                    <option value="3">3時間ごと</option>
                                    <option value="12">12時間ごと</option>
                                    <option value="24">1日ごと</option>
                                </select>
                                <small style="color:#666; display:block; margin-top:5px;">⏱️ 選択した画像ごとに、この間隔で投稿予約されます</small>
                            </div>
                        </div>

                        <div class="card-section">
                            <div class="form-group">
                                <label for="bulk_text_mode">テキスト設定</label>
                                <select id="bulk_text_mode" onchange="updateBulkTextPreview()" required>
                                    <option value="">選択してください</option>
                                    <option value="fixed">固定テキスト（全部同じ）</option>
                                    <option value="number">連番（(1/N)を付ける）</option>
                                    <option value="filename">ファイル名を使用</option>
                                </select>
                                <small style="color:#666; display:block; margin-top:5px;">📝 各投稿のテキスト内容をどのように変えるか選択</small>
                            </div>

                            <div class="form-group" id="bulk_text_input_group" style="display: none;">
                                <label for="bulk_text">テキスト</label>
                                <textarea id="bulk_text" placeholder="全ツイート共通のテキストを入力&#10;（連番モードでは先頭に追加されます）"></textarea>
                                <small id="bulk_text_preview" style="color:#666; margin-top:5px;"></small>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>📋 予約内容プレビュー</label>
                            <div id="bulk_preview" class="card-preview-list" style="max-height: 320px; overflow-y: auto;">
                                <p style="color: #999;">画像と間隔を選択すると表示されます</p>
                            </div>
                        </div>

                        <button type="submit" class="btn-save">一括予約する（<span id="bulk_tweet_count">0</span>件）</button>
                    </form>
                </div>

                <section class="card-preview-section">
                    <h4>リアルタイムプレビュー</h4>
                    <div id="card-preview-list" class="card-preview-list"></div>
                </section>

                <div id="tab-mega" class="tab-panel" style="display:none; margin-top:16px;">
                    <div style="background:var(--tab-bg); border:1px solid var(--border); border-radius:8px; padding:10px; margin-bottom:12px;">
                        <strong>🚀 メガ予約について</strong>
                        <p style="margin:6px 0 0 0; font-size:0.9em; line-height:1.5;">最大150枚の大量画像を1枚ずつ自動予約します。開始日時と間隔を指定するだけで、連番付きで順次投稿予約されます。</p>
                    </div>
                    <h3 style="margin-top:0;">メガ予約モード（大量画像）</h3>
                    <p style="color:#666;">最大150枚を1枚ずつ順次送信します。</p>
                    <div class="form-group">
                        <label for="mega_start_time">開始日時</label>
                        <input type="datetime-local" id="mega_start_time">
                    </div>
                    <div class="form-group">
                        <label for="mega_interval">投稿間隔</label>
                        <select id="mega_interval">
                            <option value="">選択してください</option>
                            <option value="1">1時間</option>
                            <option value="2">2時間</option>
                            <option value="3">3時間</option>
                            <option value="6">6時間</option>
                            <option value="12">12時間</option>
                            <option value="24">1日</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="mega_text">テキスト（任意）</label>
                        <input type="text" id="mega_text" placeholder="例: Day">
                        <small style="color:#666;">連番は自動で (1/N) 形式が付きます。</small>
                    </div>
                    <div style="margin:8px 0; font-size:0.9em; color:#333;">選択中: <span id="mega-image-count">0 / 150</span></div>
                    <button type="button" id="mega_schedule_btn" class="btn-save" style="background:#ff7a1a; margin-top:4px;">メガ予約を実行</button>
                    <div id="mega-progress" style="margin-top:10px;">
                        <div style="display:flex; justify-content:space-between; font-size:0.85em; color:#666;">
                            <span id="mega-progress-text">未開始</span>
                            <span id="mega-progress-status"></span>
                        </div>
                        <div style="position:relative; background:#eee; border-radius:4px; height:8px; overflow:hidden; margin-top:6px;">
                            <div id="mega-progress-bar" style="position:absolute; left:0; top:0; height:100%; width:0; background:#1da1f2; transition:width 0.2s ease;"></div>
                        </div>
                    </div>
                    <small style="color:#777; display:block; margin-top:8px;">1枚ずつ順次予約します。画面を閉じずにお待ちください。</small>
                </div>
            </main>

            <aside class="column history-col">
                <h3>履歴 / 予約</h3>
                <div class="history-grid">
                    <div class="history-card">
                        <h4>予約</h4>
                        <div id="scheduled-list"></div>
                    </div>
                    <div class="history-card">
                        <h4>履歴</h4>
                        <div id="posted-list"></div>
                    </div>
                </div>
            </aside>
        </div>
    </div>
    <script src="app.js?v=4"></script>
    <script>
        // このページが開かれた時に実行
        const urlParams = new URLSearchParams(window.location.search);
        const accountId = urlParams.get('id');
        if (accountId) {
            loadAccountDetail(accountId);
        }
    </script>
</body>
</html>
