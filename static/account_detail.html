<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>投稿管理 - X Manager</title>
    <link rel="stylesheet" href="style.css?v=2">
</head>
<body>
    <div class="container">
        <header>
            <h1 id="account-name">読み込み中...</h1>
            <a href="index.html" class="btn-add" style="background:#666;">ダッシュボードに戻る</a>
        </header>

        <div class="container-3col">
            <aside class="column images-col">
                <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
                    <h3 style="margin:0;">画像</h3>
                    <label style="font-size:0.9em; display:flex; align-items:center; gap:6px; cursor:pointer;">
                        <input type="checkbox" id="megaModeToggle" onchange="toggleMegaMode()">
                        <span>メガ予約モード</span>
                    </label>
                </div>
                <div id="drop-zone">ドラッグ＆ドロップで追加</div>
                <div id="image-gallery" class="gallery"></div>

                <div id="megaSchedulerPanel" style="margin-top:12px; padding:10px; border:1px solid #eee; border-radius:6px; background:#fbfbfb; display:none;">
                    <h4 style="margin:0 0 8px 0; font-size:0.95em;">メガ予約モード（大量画像）</h4>
                    <small style="color:#666; display:block; margin-bottom:8px;">最大150枚を1枚ずつ順次送信します。</small>
                    <div class="form-group" style="margin-bottom:10px;">
                        <label for="mega_start_time" style="margin-bottom:4px;">開始日時</label>
                        <input type="datetime-local" id="mega_start_time">
                    </div>
                    <div class="form-group" style="margin-bottom:10px;">
                        <label for="mega_interval" style="margin-bottom:4px;">投稿間隔</label>
                        <select id="mega_interval">
                            <option value="">選択してください</option>
                            <option value="1">1時間</option>
                            <option value="2">2時間</option>
                            <option value="3">3時間</option>
                            <option value="6">6時間</option>
                            <option value="12">12時間</option>
                            <option value="24">1日</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin-bottom:10px;">
                        <label for="mega_text" style="margin-bottom:4px;">テキスト（任意）</label>
                        <input type="text" id="mega_text" placeholder="例: Day">
                        <small style="color:#666;">連番は自動で (1/N) 形式が付きます。</small>
                    </div>
                    <div style="margin:8px 0; font-size:0.9em; color:#333;">選択中: <span id="mega-image-count">0 / 150</span></div>
                    <button type="button" id="mega_schedule_btn" class="btn-save" style="background:#ff7a1a; margin-top:4px;">メガ予約を実行</button>
                    <div id="mega-progress" style="margin-top:10px;">
                        <div style="display:flex; justify-content:space-between; font-size:0.85em; color:#666;">
                            <span id="mega-progress-text">未開始</span>
                            <span id="mega-progress-status"></span>
                        </div>
                        <div style="position:relative; background:#eee; border-radius:4px; height:8px; overflow:hidden; margin-top:6px;">
                            <div id="mega-progress-bar" style="position:absolute; left:0; top:0; height:100%; width:0; background:#1da1f2; transition:width 0.2s ease;"></div>
                        </div>
                    </div>
                    <small style="color:#777; display:block; margin-top:8px;">1枚ずつ順次予約します。画面を閉じずにお待ちください。</small>
                </div>
            </aside>

            <main class="column form-col">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3>投稿する</h3>
                    <label style="display: flex; align-items: center; gap: 8px; font-size: 0.9em; cursor: pointer;">
                        <input type="checkbox" id="bulkModeToggle" onchange="toggleBulkMode()">
                        <span>一括予約モード</span>
                    </label>
                </div>
                
                <div class="form-group">
                    <label>選択画像（最大4枚）</label>
                    <div id="selected-image-preview" class="image-preview-multi">
                        <p style="color:#999; margin:0; text-align:center;">画像を選択してください（1～4枚）</p>
                    </div>
                    <small style="color:#666; display:block; margin-top:5px;" id="image-count">選択中：0 / 4</small>
                </div>
                
                <!-- 通常モード -->
                <form id="tweetForm" style="display: block;">
                    <div class="form-group">
                        <label for="content">ツイート内容（オプション）</label>
                        <textarea id="content" placeholder="テキストなし（画像のみ）でも投稿できます。"></textarea>
                        <small id="char-count">0 / 280</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="scheduled_at">予約日時</label>
                        <input type="datetime-local" id="scheduled_at" required>
                    </div>
                    
                    <button type="submit" class="btn-save">予約する</button>
                </form>

                <!-- 一括予約モード -->
                <form id="bulkTweetForm" style="display: none;">
                    <div class="form-group">
                        <label for="bulk_start_time">開始日時</label>
                        <input type="datetime-local" id="bulk_start_time" required>
                        <small style="color:#666; display:block; margin-top:5px;">📅 最初の投稿をいつにするか設定してください</small>
                    </div>

                    <div class="form-group">
                        <label for="bulk_interval">間隔</label>
                        <select id="bulk_interval" required>
                            <option value="">選択してください</option>
                            <option value="1">1時間ごと</option>
                            <option value="3">3時間ごと</option>
                            <option value="12">12時間ごと</option>
                            <option value="24">1日ごと</option>
                        </select>
                        <small style="color:#666; display:block; margin-top:5px;">⏱️ 選択した画像ごとに、この間隔で投稿予約されます</small>
                    </div>

                    <div class="form-group">
                        <label for="bulk_text_mode">テキスト設定</label>
                        <select id="bulk_text_mode" onchange="updateBulkTextPreview()" required>
                            <option value="">選択してください</option>
                            <option value="fixed">固定テキスト（全部同じ）</option>
                            <option value="number">連番（(1/N)を付ける）</option>
                            <option value="filename">ファイル名を使用</option>
                        </select>
                        <small style="color:#666; display:block; margin-top:5px;">📝 各投稿のテキスト内容をどのように変えるか選択</small>
                    </div>

                    <div class="form-group" id="bulk_text_input_group" style="display: none;">
                        <label for="bulk_text">テキスト</label>
                        <textarea id="bulk_text" placeholder="全ツイート共通のテキストを入力&#10;（連番モードでは先頭に追加されます）"></textarea>
                        <small id="bulk_text_preview" style="color:#666; margin-top:5px;"></small>
                    </div>

                    <div class="form-group">
                        <label>📋 予約内容プレビュー</label>
                        <div id="bulk_preview" style="max-height: 300px; overflow-y: auto; background: #f9f9f9; border: 1px solid #ddd; border-radius: 4px; padding: 10px; font-size: 0.85em;">
                            <p style="color: #999;">画像と間隔を選択すると表示されます</p>
                        </div>
                    </div>

                    <button type="submit" class="btn-save">一括予約する（<span id="bulk_tweet_count">0</span>件）</button>
                </form>
                
                <div style="margin-top:20px; padding:15px; background:#f0f7ff; border-radius:8px;">
                    <div id="normalModeHint">
                        <p style="margin:0 0 10px 0; font-size:0.85em; color:#666;">
                            💡 <strong>ヒント:</strong> 複数の投稿を同じ画像で予約したい場合、次のようにしてください：
                        </p>
                        <ol style="margin:0; padding-left:20px; font-size:0.85em; color:#666;">
                            <li>左カラムから画像を選択</li>
                            <li>ツイート内容と日時を入力</li>
                            <li>「予約する」をクリック</li>
                            <li>繰り返す（画像は同じまま）</li>
                        </ol>
                    </div>
                    <div id="bulkModeHint" style="display: none;">
                        <p style="margin:0 0 10px 0; font-size:0.85em; color:#666;">
                            🚀 <strong>一括予約モードの使い方：</strong>
                        </p>
                        <ol style="margin:0; padding-left:20px; font-size:0.85em; color:#666;">
                            <li>複数の画像を選択（最大4枚）</li>
                            <li>開始日時、間隔、テキスト設定を選択</li>
                            <li>プレビューで予約内容を確認</li>
                            <li>「一括予約する」をクリック</li>
                        </ol>
                    </div>
                </div>
            </main>

            <aside class="column history-col">
                <h3>りれき</h3>
                <div id="combined-timeline"></div>
            </aside>
        </div>
    </div>
    <script src="app.js?v=2"></script>
    <script>
        // このページが開かれた時に実行
        const urlParams = new URLSearchParams(window.location.search);
        const accountId = urlParams.get('id');
        if (accountId) {
            loadAccountDetail(accountId);
        }
    </script>
</body>
</html>
